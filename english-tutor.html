<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>מורה לאנגלית</title>
<link rel="manifest" href="data:application/json,{%22name%22:%22%D7%9E%D7%95%D7%A8%D7%94%20%D7%9C%D7%90%D7%A0%D7%92%D7%9C%D7%99%D7%AA%22,%22short_name%22:%22%D7%9E%D7%95%D7%A8%D7%94%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%23f0f4ff%22,%22theme_color%22:%224a6cf7%22}">
<meta name="theme-color" content="#4a6cf7">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #f0f4ff;
  color: #1a1a2e;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  overflow-x: hidden;
}
.header {
  background: linear-gradient(135deg, #4a6cf7, #6a5af7);
  color: white;
  padding: 20px;
  text-align: center;
  box-shadow: 0 2px 10px rgba(74,108,247,0.3);
  position: relative;
  z-index: 10;
}
.header h1 { font-size: 1.4em; font-weight: 600; }
.header p { font-size: 0.85em; opacity: 0.9; margin-top: 4px; }

.score-bar {
  display: none;
  justify-content: center;
  gap: 24px;
  padding: 10px 20px;
  background: white;
  border-bottom: 1px solid #e8e8e8;
  font-size: 0.85em;
  font-weight: 600;
  direction: ltr;
}
.score-bar.active { display: flex; }
.score-bar .stat { display: flex; align-items: center; gap: 5px; }
.score-bar .score-val { color: #4a6cf7; }
.score-bar .streak-val { color: #ff9800; }
.score-bar .attempt-val { color: #888; }

.topics {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  padding: 16px;
  overflow-y: auto;
  flex: 1;
}
.topic-card {
  background: white;
  border-radius: 16px;
  padding: 18px 12px;
  text-align: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  cursor: pointer;
  transition: transform 0.15s;
  border: 2px solid transparent;
}
.topic-card:active { transform: scale(0.97); }
.topic-card .icon { font-size: 2em; margin-bottom: 6px; }
.topic-card .label { font-size: 0.85em; font-weight: 600; color: #333; }

.lesson { display: none; flex-direction: column; flex: 1; }
.lesson.active { display: flex; }
.topics.hidden { display: none; }

.progress-bar { height: 4px; background: #e0e0e0; direction: ltr; }
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #4a6cf7, #6a5af7);
  transition: width 0.4s ease;
  border-radius: 2px;
}
.step-info { text-align: center; padding: 10px; font-size: 0.85em; color: #888; }

.tutor-message {
  padding: 12px 20px;
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
.bubble {
  background: white;
  border-radius: 20px;
  padding: 22px;
  max-width: 340px;
  width: 100%;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  text-align: center;
  transition: transform 0.3s;
  position: relative;
}
.bubble .intro { font-size: 0.9em; color: #666; margin-bottom: 10px; }
.bubble .sentence {
  font-size: 1.3em;
  font-weight: 600;
  color: #1a1a2e;
  line-height: 1.5;
  margin-bottom: 6px;
  direction: ltr;
  text-align: center;
}
.bubble .translation { font-size: 0.85em; color: #888; margin-bottom: 8px; }

.feedback {
  min-height: 70px;
  padding: 12px 20px;
  text-align: center;
  font-size: 1em;
  line-height: 1.5;
}
.feedback.correct { color: #2e7d32; }
.feedback.close { color: #e65100; }
.feedback.wrong { color: #c62828; }
.feedback .heard { font-size: 0.85em; color: #888; margin-top: 6px; direction: ltr; }
.word-ok { color: #2e7d32; font-weight: 600; }
.word-miss { color: #c62828; text-decoration: underline; font-weight: 600; }
.word-diff { direction: ltr; display: inline-block; }

.skip-btn {
  display: none;
  margin: 6px auto 0;
  background: none;
  border: 1px solid #ccc;
  color: #888;
  border-radius: 8px;
  padding: 6px 16px;
  font-size: 0.85em;
  cursor: pointer;
}
.skip-btn.visible { display: block; }

/* ===== STATE AREA ===== */
.state-area {
  padding: 12px 20px 28px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}
.state-label { font-size: 0.9em; color: #888; min-height: 20px; font-weight: 500; }

/* --- Ear animation (tutor speaking = user listens) --- */
.ear-anim {
  display: none;
  flex-direction: column;
  align-items: center;
  gap: 6px;
}
.ear-anim.active { display: flex; }
.ear-icon {
  width: 80px; height: 80px;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}
.ear-icon .ear-emoji { font-size: 3em; animation: ear-tilt 1.5s ease-in-out infinite; }
@keyframes ear-tilt {
  0%, 100% { transform: rotate(-5deg) scale(1); }
  50% { transform: rotate(5deg) scale(1.08); }
}
/* Sound rings coming into the ear */
.ear-rings {
  position: absolute;
  right: -2px; top: 50%;
  transform: translateY(-50%);
}
.ear-ring {
  position: absolute;
  right: 0; top: 50%; transform: translateY(-50%);
  width: 14px; height: 14px;
  border: 2px solid #ff9800;
  border-radius: 50%;
  opacity: 0;
  animation: ear-ring-pulse 1.8s ease-out infinite;
}
.ear-ring:nth-child(1) { animation-delay: 0s; }
.ear-ring:nth-child(2) { width: 26px; height: 26px; animation-delay: 0.4s; }
.ear-ring:nth-child(3) { width: 38px; height: 38px; animation-delay: 0.8s; }
@keyframes ear-ring-pulse {
  0% { opacity: 0.8; transform: translateY(-50%) scale(0.5); }
  100% { opacity: 0; transform: translateY(-50%) scale(1.2); }
}

/* --- Mic animation (user's turn to speak) --- */
.mic-anim {
  display: none;
  flex-direction: column;
  align-items: center;
  gap: 6px;
}
.mic-anim.active { display: flex; }
.mic-icon-wrap {
  width: 80px; height: 80px;
  border-radius: 50%;
  background: linear-gradient(135deg, #4a6cf7, #6a5af7);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  animation: mic-glow 1.5s ease-in-out infinite;
}
@keyframes mic-glow {
  0%, 100% { box-shadow: 0 0 0 0 rgba(74,108,247,0.5); }
  50% { box-shadow: 0 0 0 18px rgba(74,108,247,0); }
}
.mic-icon-wrap .mic-emoji { font-size: 2.2em; }
/* Sound bars coming out of mic */
.mic-bars {
  display: flex;
  align-items: center;
  gap: 3px;
  height: 30px;
  margin-top: 4px;
}
.mic-bars .bar {
  width: 5px;
  border-radius: 3px;
  background: linear-gradient(180deg, #4a6cf7, #6a5af7);
  animation: mic-wave 0.5s ease-in-out infinite alternate;
}
.mic-bars .bar:nth-child(1) { height: 8px; animation-delay: 0s; }
.mic-bars .bar:nth-child(2) { height: 18px; animation-delay: 0.08s; }
.mic-bars .bar:nth-child(3) { height: 26px; animation-delay: 0.16s; }
.mic-bars .bar:nth-child(4) { height: 18px; animation-delay: 0.24s; }
.mic-bars .bar:nth-child(5) { height: 8px; animation-delay: 0.32s; }
.mic-bars .bar:nth-child(6) { height: 14px; animation-delay: 0.4s; }
.mic-bars .bar:nth-child(7) { height: 22px; animation-delay: 0.48s; }
@keyframes mic-wave {
  0% { transform: scaleY(0.3); opacity: 0.6; }
  100% { transform: scaleY(1); opacity: 1; }
}

/* --- Idle state --- */
.idle-anim {
  display: none;
  flex-direction: column;
  align-items: center;
  gap: 6px;
}
.idle-anim.active { display: flex; }
.idle-icon {
  width: 60px; height: 60px;
  border-radius: 50%;
  background: #e0e0e0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.8em;
  color: #999;
}

.back-btn {
  position: absolute; top: 18px; right: 16px; left: auto;
  background: none; border: none; color: white;
  font-size: 1.4em; cursor: pointer; padding: 4px 8px;
}

.complete-screen {
  display: none; flex-direction: column; align-items: center;
  justify-content: center; flex: 1; padding: 40px 20px; text-align: center;
}
.complete-screen.active { display: flex; }
.complete-screen .big-icon { font-size: 4em; margin-bottom: 16px; }
.complete-screen h2 { font-size: 1.5em; margin-bottom: 8px; color: #2e7d32; }
.complete-screen .final-score { font-size: 1.1em; color: #4a6cf7; font-weight: 600; margin-bottom: 8px; }
.complete-screen p { color: #666; margin-bottom: 24px; }
.complete-screen button {
  background: linear-gradient(135deg, #4a6cf7, #6a5af7);
  color: white; border: none; border-radius: 12px;
  padding: 14px 32px; font-size: 1em; font-weight: 600; cursor: pointer;
}

.no-support { display: none; padding: 40px 20px; text-align: center; color: #c62828; }

/* ===== ANIMATIONS ===== */
/* Confetti canvas for success */
#confettiCanvas {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none; z-index: 100;
}

/* Sparkle animation for partial */
.sparkle-container {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none; z-index: 100;
}
.sparkle-dot {
  position: absolute;
  width: 8px; height: 8px;
  border-radius: 50%;
  animation: sparkle-float 1.2s ease-out forwards;
  opacity: 0;
}
@keyframes sparkle-float {
  0% { opacity: 1; transform: scale(0) translateY(0); }
  40% { opacity: 1; transform: scale(1.2) translateY(-30px); }
  100% { opacity: 0; transform: scale(0.5) translateY(-80px); }
}

/* Bubble success glow */
.bubble.glow-success {
  animation: bubble-glow-green 0.8s ease;
}
@keyframes bubble-glow-green {
  0% { box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
  40% { box-shadow: 0 0 30px rgba(46,125,50,0.4), 0 0 60px rgba(46,125,50,0.2); transform: scale(1.03); }
  100% { box-shadow: 0 2px 12px rgba(0,0,0,0.08); transform: scale(1); }
}

/* Bubble partial shimmer */
.bubble.shimmer-partial {
  animation: bubble-shimmer 0.6s ease;
}
@keyframes bubble-shimmer {
  0% { box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
  50% { box-shadow: 0 0 20px rgba(255,152,0,0.3); }
  100% { box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
}

/* Completion fireworks */
.firework {
  position: fixed;
  pointer-events: none;
  z-index: 100;
}
.firework-dot {
  position: absolute;
  width: 6px; height: 6px;
  border-radius: 50%;
  animation: fw-burst 1s ease-out forwards;
}
@keyframes fw-burst {
  0% { opacity: 1; transform: translate(0,0) scale(1); }
  100% { opacity: 0; transform: translate(var(--dx), var(--dy)) scale(0.3); }
}
</style>
</head>
<body>

<canvas id="confettiCanvas"></canvas>

<div class="header">
  <button class="back-btn" id="backBtn" style="display:none" onclick="goHome()">&#8594;</button>
  <h1>&#127891; מורה לאנגלית</h1>
  <p id="headerSub">בחר נושא לשיעור</p>
</div>

<div class="no-support" id="noSupport">
  <p>הדפדפן שלך לא תומך בזיהוי דיבור. נא להשתמש ב-<strong>Google Chrome</strong> באנדרואיד.</p>
</div>

<div class="score-bar" id="scoreBar">
  <div class="stat">&#11088; <span class="score-val" id="scoreVal">0</span></div>
  <div class="stat">&#128293; <span class="streak-val" id="streakVal">0</span></div>
  <div class="stat">&#128260; <span class="attempt-val" id="attemptVal">1</span></div>
</div>

<div class="topics" id="topicsView">
  <div class="topic-card" onclick="startLesson('recipe')"><div class="icon">&#129367;</div><div class="label">להכין סלט</div></div>
  <div class="topic-card" onclick="startLesson('daily')"><div class="icon">&#9728;&#65039;</div><div class="label">שגרת יום</div></div>
  <div class="topic-card" onclick="startLesson('store')"><div class="icon">&#128722;</div><div class="label">ללכת לחנות</div></div>
  <div class="topic-card" onclick="startLesson('introduce')"><div class="icon">&#128075;</div><div class="label">להציג את עצמך</div></div>
  <div class="topic-card" onclick="startLesson('weather')"><div class="icon">&#127782;&#65039;</div><div class="label">מזג אוויר</div></div>
  <div class="topic-card" onclick="startLesson('family')"><div class="icon">&#128104;&#8205;&#128105;&#8205;&#128103;&#8205;&#128102;</div><div class="label">המשפחה שלי</div></div>
  <div class="topic-card" onclick="startLesson('school')"><div class="icon">&#127979;</div><div class="label">בית הספר</div></div>
  <div class="topic-card" onclick="startLesson('doctor')"><div class="icon">&#129657;</div><div class="label">אצל הרופא</div></div>
  <div class="topic-card" onclick="startLesson('restaurant')"><div class="icon">&#127869;</div><div class="label">במסעדה</div></div>
  <div class="topic-card" onclick="startLesson('park')"><div class="icon">&#127795;</div><div class="label">בפארק</div></div>
  <div class="topic-card" onclick="startLesson('birthday')"><div class="icon">&#127874;</div><div class="label">יום הולדת</div></div>
  <div class="topic-card" onclick="startLesson('travel')"><div class="icon">&#9992;&#65039;</div><div class="label">טיול לחו&quot;ל</div></div>
  <div class="topic-card" onclick="startLesson('pets')"><div class="icon">&#128054;</div><div class="label">חיות מחמד</div></div>
  <div class="topic-card" onclick="startLesson('sports')"><div class="icon">&#9917;</div><div class="label">ספורט</div></div>
  <div class="topic-card" onclick="startLesson('beach')"><div class="icon">&#127958;&#65039;</div><div class="label">בחוף הים</div></div>
  <div class="topic-card" onclick="startLesson('feelings')"><div class="icon">&#128522;</div><div class="label">רגשות</div></div>
</div>

<div class="lesson" id="lessonView">
  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  <div class="step-info" id="stepInfo"></div>
  <div class="tutor-message">
    <div class="bubble" id="bubble">
      <div class="intro" id="introText"></div>
      <div class="sentence" id="sentenceText"></div>
      <div class="translation" id="translationText"></div>
    </div>
  </div>
  <div class="feedback" id="feedback"></div>
  <button class="skip-btn" id="skipBtn" onclick="skipStep()">&#8592; דלג על זה</button>
  <div class="state-area" id="stateArea">
    <!-- Ear animation: tutor is speaking, user should listen -->
    <div class="ear-anim" id="earAnim">
      <div class="ear-icon">
        <span class="ear-emoji">&#128066;</span>
        <div class="ear-rings">
          <div class="ear-ring"></div>
          <div class="ear-ring"></div>
          <div class="ear-ring"></div>
        </div>
      </div>
      <div class="state-label" id="earLabel">...הקשב</div>
    </div>
    <!-- Mic animation: user's turn to speak -->
    <div class="mic-anim" id="micAnim">
      <div class="mic-icon-wrap">
        <span class="mic-emoji">&#127908;</span>
      </div>
      <div class="mic-bars">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div>
        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
      </div>
      <div class="state-label" id="micLabel">...דבר עכשיו</div>
    </div>
    <!-- Idle state -->
    <div class="idle-anim active" id="idleAnim">
      <div class="idle-icon">&#127908;</div>
      <div class="state-label" id="idleLabel"></div>
    </div>
  </div>
</div>

<div class="complete-screen" id="completeScreen">
  <div class="big-icon">&#127881;</div>
  <h2>כל הכבוד!</h2>
  <div class="final-score" id="finalScore"></div>
  <p>סיימת את השיעור!</p>
  <button onclick="goHome()">בחר שיעור נוסף</button>
</div>

<script>
var lessons = {
  recipe: {
    title: "להכין סלט",
    sentences: [
      "First, I wash the vegetables.",
      "Then, I cut the vegetables.",
      "I put them in a bowl.",
      "I add some salt.",
      "I add olive oil.",
      "I mix everything together.",
      "The salad is ready!",
      "Let's eat!"
    ],
    translations: [
      "קודם, אני שוטף את הירקות.",
      "אחר כך, אני חותך את הירקות.",
      "אני שם אותם בקערה.",
      "אני מוסיף קצת מלח.",
      "אני מוסיף שמן זית.",
      "אני מערבב הכל ביחד.",
      "הסלט מוכן!",
      "בואו נאכל!"
    ]
  },
  daily: {
    title: "שגרת היום שלי",
    sentences: [
      "I wake up in the morning.",
      "I brush my teeth.",
      "I eat breakfast.",
      "I go to school.",
      "I study with my friends.",
      "I come home.",
      "I do my homework.",
      "I go to sleep. Good night!"
    ],
    translations: [
      "אני מתעורר בבוקר.",
      "אני מצחצח שיניים.",
      "אני אוכל ארוחת בוקר.",
      "אני הולך לבית הספר.",
      "אני לומד עם החברים שלי.",
      "אני חוזר הביתה.",
      "אני עושה שיעורי בית.",
      "אני הולך לישון. לילה טוב!"
    ]
  },
  store: {
    title: "ללכת לחנות",
    sentences: [
      "I need to buy some food.",
      "I walk to the store.",
      "I take a shopping cart.",
      "I buy bread and milk.",
      "I buy some fruit.",
      "I go to pay.",
      "I put the food in a bag.",
      "I walk home."
    ],
    translations: [
      "אני צריך לקנות אוכל.",
      "אני הולך לחנות.",
      "אני לוקח עגלת קניות.",
      "אני קונה לחם וחלב.",
      "אני קונה פירות.",
      "אני הולך לשלם.",
      "אני שם את האוכל בשקית.",
      "אני הולך הביתה."
    ]
  },
  introduce: {
    title: "להציג את עצמך",
    sentences: [
      "Hello! My name is...",
      "I am from Israel.",
      "I am learning English.",
      "I like to read books.",
      "I like music.",
      "My favorite color is blue.",
      "Nice to meet you!",
      "Thank you and goodbye!"
    ],
    translations: [
      "שלום! קוראים לי...",
      "אני מישראל.",
      "אני לומד אנגלית.",
      "אני אוהב לקרוא ספרים.",
      "אני אוהב מוזיקה.",
      "הצבע האהוב עליי הוא כחול.",
      "נעים להכיר!",
      "תודה ולהתראות!"
    ]
  },
  weather: {
    title: "מזג אוויר",
    sentences: [
      "What is the weather today?",
      "Today is very sunny.",
      "It is hot outside.",
      "I need my sunglasses.",
      "Tomorrow it will rain.",
      "I will take an umbrella.",
      "In winter it is cold.",
      "I like the spring weather."
    ],
    translations: [
      "מה מזג האוויר היום?",
      "היום מאוד שמשי.",
      "חם בחוץ.",
      "אני צריך את משקפי השמש.",
      "מחר ירד גשם.",
      "אני אקח מטריה.",
      "בחורף קר.",
      "אני אוהב את מזג האוויר באביב."
    ]
  },
  family: {
    title: "המשפחה שלי",
    sentences: [
      "I have a big family.",
      "My mother is very kind.",
      "My father is tall.",
      "I have one brother.",
      "I have two sisters.",
      "My grandmother cooks well.",
      "My grandfather tells stories.",
      "I love my family."
    ],
    translations: [
      "יש לי משפחה גדולה.",
      "אמא שלי מאוד טובה.",
      "אבא שלי גבוה.",
      "יש לי אח אחד.",
      "יש לי שתי אחיות.",
      "סבתא שלי מבשלת טוב.",
      "סבא שלי מספר סיפורים.",
      "אני אוהב את המשפחה שלי."
    ]
  },
  school: {
    title: "בית הספר",
    sentences: [
      "I go to school every day.",
      "My teacher is very nice.",
      "I sit next to my friend.",
      "We learn math and science.",
      "I like English class.",
      "We have a break at ten.",
      "I eat lunch at school.",
      "School is fun!"
    ],
    translations: [
      "אני הולך לבית הספר כל יום.",
      "המורה שלי מאוד נחמדה.",
      "אני יושב ליד החבר שלי.",
      "אנחנו לומדים מתמטיקה ומדעים.",
      "אני אוהב שיעור אנגלית.",
      "יש לנו הפסקה בעשר.",
      "אני אוכל צהריים בבית הספר.",
      "בית הספר כיף!"
    ]
  },
  doctor: {
    title: "אצל הרופא",
    sentences: [
      "I don't feel well.",
      "I have a headache.",
      "My throat hurts.",
      "I need to see the doctor.",
      "The doctor checks me.",
      "I need some medicine.",
      "I should rest at home.",
      "I feel better now. Thank you!"
    ],
    translations: [
      "אני לא מרגיש טוב.",
      "כואב לי הראש.",
      "כואב לי הגרון.",
      "אני צריך ללכת לרופא.",
      "הרופא בודק אותי.",
      "אני צריך תרופה.",
      "אני צריך לנוח בבית.",
      "אני מרגיש יותר טוב עכשיו. תודה!"
    ]
  },
  restaurant: {
    title: "במסעדה",
    sentences: [
      "Can I see the menu please?",
      "I would like some water.",
      "I want pizza and salad.",
      "The food is very good.",
      "Can I have more bread?",
      "I am full now.",
      "Can I have the check please?",
      "Thank you! The food was great!"
    ],
    translations: [
      "אפשר לראות את התפריט בבקשה?",
      "אני רוצה מים בבקשה.",
      "אני רוצה פיצה וסלט.",
      "האוכל מאוד טעים.",
      "אפשר עוד לחם?",
      "אני שבע עכשיו.",
      "אפשר את החשבון בבקשה?",
      "תודה! האוכל היה מעולה!"
    ]
  },
  park: {
    title: "בפארק",
    sentences: [
      "Let's go to the park!",
      "I can see the trees.",
      "The flowers are beautiful.",
      "I play on the slide.",
      "I swing very high.",
      "I ride my bicycle.",
      "We sit on the grass.",
      "The park is my favorite place."
    ],
    translations: [
      "בואו נלך לפארק!",
      "אני רואה את העצים.",
      "הפרחים יפים.",
      "אני משחק על המגלשה.",
      "אני מתנדנד גבוה.",
      "אני רוכב על האופניים.",
      "אנחנו יושבים על הדשא.",
      "הפארק הוא המקום האהוב עליי."
    ]
  },
  birthday: {
    title: "יום הולדת",
    sentences: [
      "Today is my birthday!",
      "I am very happy.",
      "My friends are coming.",
      "We have a big cake.",
      "I blow out the candles.",
      "I open my presents.",
      "We play games together.",
      "This is the best day!"
    ],
    translations: [
      "היום יום ההולדת שלי!",
      "אני מאוד שמח.",
      "החברים שלי באים.",
      "יש לנו עוגה גדולה.",
      "אני מכבה את הנרות.",
      "אני פותח את המתנות.",
      "אנחנו משחקים משחקים ביחד.",
      "זה היום הכי טוב!"
    ]
  },
  travel: {
    title: "טיול לחו\"ל",
    sentences: [
      "We are going on a trip!",
      "I pack my suitcase.",
      "We go to the airport.",
      "The airplane is very big.",
      "We fly above the clouds.",
      "We arrive at the hotel.",
      "I take many pictures.",
      "The trip was wonderful!"
    ],
    translations: [
      "אנחנו יוצאים לטיול!",
      "אני אורז את המזוודה.",
      "אנחנו נוסעים לשדה התעופה.",
      "המטוס מאוד גדול.",
      "אנחנו טסים מעל העננים.",
      "אנחנו מגיעים למלון.",
      "אני מצלם הרבה תמונות.",
      "הטיול היה נפלא!"
    ]
  },
  pets: {
    title: "חיות מחמד",
    sentences: [
      "I have a dog.",
      "My dog is brown.",
      "He likes to run and play.",
      "I walk him every day.",
      "I give him food and water.",
      "He sleeps on my bed.",
      "My cat is black and white.",
      "I love my pets very much."
    ],
    translations: [
      "יש לי כלב.",
      "הכלב שלי חום.",
      "הוא אוהב לרוץ ולשחק.",
      "אני מטייל איתו כל יום.",
      "אני נותן לו אוכל ומים.",
      "הוא ישן על המיטה שלי.",
      "החתולה שלי שחורה ולבנה.",
      "אני אוהב את חיות המחמד שלי מאוד."
    ]
  },
  sports: {
    title: "ספורט",
    sentences: [
      "I like to play sports.",
      "My favorite sport is soccer.",
      "I kick the ball very hard.",
      "We play as a team.",
      "I also like to swim.",
      "I run very fast.",
      "We won the game!",
      "Sports make me strong and happy."
    ],
    translations: [
      "אני אוהב לעשות ספורט.",
      "הספורט האהוב עליי הוא כדורגל.",
      "אני בועט בכדור חזק.",
      "אנחנו משחקים כקבוצה.",
      "אני גם אוהב לשחות.",
      "אני רץ מהר מאוד.",
      "ניצחנו במשחק!",
      "ספורט עושה אותי חזק ושמח."
    ]
  },
  beach: {
    title: "בחוף הים",
    sentences: [
      "Let's go to the beach!",
      "The sand is warm.",
      "The water is blue.",
      "I swim in the sea.",
      "I build a sand castle.",
      "I play with the waves.",
      "The sun is very hot.",
      "I love the beach!"
    ],
    translations: [
      "בואו נלך לחוף הים!",
      "החול חם.",
      "המים כחולים.",
      "אני שוחה בים.",
      "אני בונה ארמון חול.",
      "אני משחק עם הגלים.",
      "השמש מאוד חמה.",
      "אני אוהב את החוף!"
    ]
  },
  feelings: {
    title: "רגשות",
    sentences: [
      "Today I am very happy.",
      "Sometimes I feel sad.",
      "I am excited about tomorrow.",
      "I feel tired today.",
      "My friend made me laugh.",
      "I am a little scared.",
      "I feel proud of myself.",
      "I am thankful for my family."
    ],
    translations: [
      "היום אני מאוד שמח.",
      "לפעמים אני מרגיש עצוב.",
      "אני נרגש לגבי מחר.",
      "אני מרגיש עייף היום.",
      "החבר שלי גרם לי לצחוק.",
      "אני קצת מפחד.",
      "אני מרגיש גאה בעצמי.",
      "אני אסיר תודה על המשפחה שלי."
    ]
  }
};

var currentLesson = null;
var currentStep = 0;
var recognition = null;
var listenActive = false;
var advancing = false;
var pendingTimers = [];
var attempts = 0;
var score = 0;
var streak = 0;
var wakeLock = null;

var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SpeechRecognition) {
  document.getElementById('noSupport').style.display = 'block';
  document.getElementById('topicsView').style.display = 'none';
}

// ===== ANIMATION SYSTEM =====
var confettiCanvas = document.getElementById('confettiCanvas');
var confettiCtx = confettiCanvas.getContext('2d');
var confettiPieces = [];
var confettiRunning = false;

function resizeCanvas() {
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

function launchConfetti() {
  confettiPieces = [];
  var colors = ['#4a6cf7','#6a5af7','#ff9800','#4caf50','#e91e63','#ffeb3b','#00bcd4','#ff5722'];
  for (var i = 0; i < 80; i++) {
    confettiPieces.push({
      x: Math.random() * confettiCanvas.width,
      y: -20 - Math.random() * 100,
      w: 6 + Math.random() * 6,
      h: 4 + Math.random() * 4,
      color: colors[Math.floor(Math.random() * colors.length)],
      vx: (Math.random() - 0.5) * 6,
      vy: 2 + Math.random() * 4,
      rot: Math.random() * 360,
      vr: (Math.random() - 0.5) * 10,
      life: 1
    });
  }
  if (!confettiRunning) {
    confettiRunning = true;
    animateConfetti();
  }
}

function animateConfetti() {
  if (!confettiRunning) return;
  confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
  var alive = 0;
  for (var i = 0; i < confettiPieces.length; i++) {
    var p = confettiPieces[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.1;
    p.rot += p.vr;
    p.life -= 0.008;
    if (p.life <= 0) continue;
    alive++;
    confettiCtx.save();
    confettiCtx.translate(p.x, p.y);
    confettiCtx.rotate(p.rot * Math.PI / 180);
    confettiCtx.globalAlpha = p.life;
    confettiCtx.fillStyle = p.color;
    confettiCtx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
    confettiCtx.restore();
  }
  if (alive > 0) {
    requestAnimationFrame(animateConfetti);
  } else {
    confettiRunning = false;
    confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
  }
}

function showSparkles() {
  var container = document.createElement('div');
  container.className = 'sparkle-container';
  document.body.appendChild(container);
  var colors = ['#ff9800','#ffc107','#ffeb3b','#ff5722','#e91e63'];
  var cx = window.innerWidth / 2;
  var cy = window.innerHeight / 2;
  for (var i = 0; i < 12; i++) {
    var dot = document.createElement('div');
    dot.className = 'sparkle-dot';
    dot.style.left = (cx - 40 + Math.random() * 80) + 'px';
    dot.style.top = (cy - 20 + Math.random() * 40) + 'px';
    dot.style.background = colors[Math.floor(Math.random() * colors.length)];
    dot.style.animationDelay = (Math.random() * 0.3) + 's';
    container.appendChild(dot);
  }
  setTimeout(function() { container.remove(); }, 1600);
}

function showCompletionFireworks() {
  launchConfetti();
  setTimeout(launchConfetti, 500);
  setTimeout(launchConfetti, 1000);
}

// ===== TIMER MANAGEMENT =====
function safeTimeout(fn, ms) {
  var id = setTimeout(function() {
    pendingTimers = pendingTimers.filter(function(t) { return t !== id; });
    fn();
  }, ms);
  pendingTimers.push(id);
  return id;
}
function clearAllTimers() {
  pendingTimers.forEach(function(id) { clearTimeout(id); });
  pendingTimers = [];
}

// ===== WAKE LOCK =====
async function requestWakeLock() {
  try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
}
function releaseWakeLock() {
  if (wakeLock) { try { wakeLock.release(); } catch(e) {} wakeLock = null; }
}

function vibrate(p) { try { if (navigator.vibrate) navigator.vibrate(p); } catch(e) {} }

function updateScoreBar() {
  document.getElementById('scoreVal').textContent = score;
  document.getElementById('streakVal').textContent = streak;
  document.getElementById('attemptVal').textContent = attempts;
}

// ===== TTS =====
function sayEnglish(text, cb) {
  var u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-US'; u.rate = 0.85;
  var done = false;
  function fin() { if (done) return; done = true; if (cb) cb(); }
  u.onend = fin; u.onerror = fin;
  var fb = safeTimeout(fin, 6000);
  var orig = fin;
  fin = function() { clearTimeout(fb); pendingTimers = pendingTimers.filter(function(t){return t!==fb;}); orig(); };
  u.onend = fin; u.onerror = fin;
  speechSynthesis.speak(u);
}

function sayHebrew(text, cb) {
  var u = new SpeechSynthesisUtterance(text);
  u.lang = 'he-IL'; u.rate = 1.0;
  var done = false;
  function fin() { if (done) return; done = true; if (cb) cb(); }
  u.onend = fin; u.onerror = fin;
  var fb = safeTimeout(fin, 5000);
  var orig = fin;
  fin = function() { clearTimeout(fb); pendingTimers = pendingTimers.filter(function(t){return t!==fb;}); orig(); };
  u.onend = fin; u.onerror = fin;
  speechSynthesis.speak(u);
}

// ===== LESSON FLOW =====
function startLesson(topic) {
  currentLesson = topic; currentStep = 0; advancing = false;
  attempts = 1; score = 0; streak = 0;
  clearAllTimers();
  document.getElementById('topicsView').classList.add('hidden');
  document.getElementById('lessonView').classList.add('active');
  document.getElementById('completeScreen').classList.remove('active');
  document.getElementById('backBtn').style.display = 'block';
  document.getElementById('scoreBar').classList.add('active');
  document.getElementById('headerSub').textContent = lessons[topic].title;
  document.getElementById('feedback').innerHTML = '';
  document.getElementById('skipBtn').classList.remove('visible');
  updateScoreBar(); showStep(); requestWakeLock(); speakThenListen();
}

function goHome() {
  clearAllTimers(); stopListening(); speechSynthesis.cancel();
  advancing = false; currentLesson = null;
  document.getElementById('topicsView').classList.remove('hidden');
  document.getElementById('lessonView').classList.remove('active');
  document.getElementById('completeScreen').classList.remove('active');
  document.getElementById('scoreBar').classList.remove('active');
  document.getElementById('backBtn').style.display = 'none';
  document.getElementById('headerSub').textContent = 'בחר נושא לשיעור';
  document.getElementById('skipBtn').classList.remove('visible');
  releaseWakeLock();
}

function showStep() {
  var d = lessons[currentLesson], total = d.sentences.length;
  document.getElementById('progressFill').style.width = ((currentStep/total)*100)+'%';
  document.getElementById('stepInfo').textContent = 'שלב '+(currentStep+1)+' מתוך '+total;
  document.getElementById('sentenceText').textContent = d.sentences[currentStep];
  document.getElementById('translationText').textContent = d.translations[currentStep];
  document.getElementById('introText').textContent = currentStep===0 ? "הקשב ואז חזור:" : "עכשיו תגיד:";
  document.getElementById('feedback').innerHTML = '';
  document.getElementById('skipBtn').classList.remove('visible');
  var b = document.getElementById('bubble');
  b.classList.remove('glow-success','shimmer-partial');
  attempts = 1; updateScoreBar();
}

function speakThenListen() {
  if (!currentLesson) return;
  stopListeningQuiet();
  setIndicator('speaking','...מקשיב');
  speechSynthesis.cancel();
  var text = lessons[currentLesson].sentences[currentStep];
  safeTimeout(function(){
    if (!currentLesson) return;
    sayHebrew('הקשב וחזור', function(){
      if (!currentLesson) return;
      safeTimeout(function(){
        if (!currentLesson) return;
        sayEnglish(text, function(){
          if (!currentLesson) return;
          safeTimeout(function(){
            if (!currentLesson) return;
            setIndicator('listening','...דבר עכשיו');
            startListening();
          },400);
        });
      },200);
    });
  },100);
}

function setIndicator(state, label) {
  var ear = document.getElementById('earAnim');
  var mic = document.getElementById('micAnim');
  var idle = document.getElementById('idleAnim');
  ear.classList.remove('active');
  mic.classList.remove('active');
  idle.classList.remove('active');

  if (state === 'speaking') {
    // Tutor is speaking -> show ear (user should listen)
    ear.classList.add('active');
    document.getElementById('earLabel').textContent = label || '...הקשב';
  } else if (state === 'listening') {
    // User's turn to speak -> show mic
    mic.classList.add('active');
    document.getElementById('micLabel').textContent = label || '...דבר עכשיו';
  } else {
    // Idle
    idle.classList.add('active');
    document.getElementById('idleLabel').textContent = label || '';
  }
}

function stopListeningQuiet() {
  listenActive = false;
  if (recognition) { try { recognition.abort(); } catch(e) {} recognition = null; }
}
function stopListening() { stopListeningQuiet(); setIndicator('idle',''); }

function startListening() {
  if (!SpeechRecognition || !currentLesson) return;
  stopListeningQuiet(); listenActive = true;
  recognition = new SpeechRecognition();
  recognition.lang = 'en-US'; recognition.interimResults = false;
  recognition.continuous = false; recognition.maxAlternatives = 1;
  var gotResult = false;
  recognition.onresult = function(e) { gotResult=true; evaluateResponse(e.results[0][0].transcript); };
  recognition.onerror = function(e) {
    if (!listenActive||!currentLesson) return;
    if (e.error==='no-speech'||e.error==='aborted') restartListening();
    else { setIndicator('idle','...מנסה שוב'); safeTimeout(restartListening,500); }
  };
  recognition.onend = function() {
    if (gotResult) return;
    if (listenActive && currentLesson && !advancing) restartListening();
  };
  try { recognition.start(); } catch(e) { safeTimeout(restartListening,300); }
}

function restartListening() {
  if (!listenActive||!currentLesson||advancing) return;
  safeTimeout(function(){
    if (!currentLesson||advancing) return;
    listenActive=true; setIndicator('listening','...דבר עכשיו'); startListening();
  },200);
}

function normalize(s) { return s.toLowerCase().replace(/[^a-z0-9\s]/g,'').replace(/\s+/g,' ').trim(); }

function similarity(a,b) {
  var wa=normalize(a).split(' ').filter(Boolean), wb=normalize(b).split(' ').filter(Boolean);
  if (!wa.length||!wb.length) return 0;
  var m=0;
  for (var i=0;i<wa.length;i++) if (wb.indexOf(wa[i])!==-1) m++;
  return m/Math.max(wa.length,wb.length);
}

function wordDiff(target,spoken) {
  var tw=normalize(target).split(' ').filter(Boolean), sw=normalize(spoken).split(' ').filter(Boolean);
  var h='';
  for (var i=0;i<tw.length;i++) {
    var c=sw.indexOf(tw[i])!==-1?'word-ok':'word-miss';
    h+='<span class="'+c+'">'+escHtml(tw[i])+'</span> ';
  }
  return '<span class="word-diff">'+h.trim()+'</span>';
}

function evaluateResponse(spoken) {
  if (!currentLesson) return;
  stopListeningQuiet();
  var target = lessons[currentLesson].sentences[currentStep];
  var sc = similarity(spoken, target);
  var fb = document.getElementById('feedback');
  var bubble = document.getElementById('bubble');
  speechSynthesis.cancel();

  if (sc >= 0.85) {
    // SUCCESS - big confetti animation
    fb.className = 'feedback correct';
    fb.innerHTML = '&#128077; !מצוין<div class="heard">"'+escHtml(spoken)+'"</div>';
    setIndicator('idle','!נכון');
    vibrate(100);

    // Animations
    launchConfetti();
    bubble.classList.remove('glow-success');
    void bubble.offsetWidth;
    bubble.classList.add('glow-success');

    var pts = attempts===1?3:attempts===2?2:1;
    score += pts; streak++;
    updateScoreBar();
    advancing = true;
    var isLast = currentStep >= lessons[currentLesson].sentences.length-1;
    var praise = isLast ? 'כל הכבוד! סיימת!' : 'מצוין!';
    safeTimeout(function(){
      if (!currentLesson) return;
      sayHebrew(praise, function(){
        if (!currentLesson) return;
        safeTimeout(nextStep,300);
      });
    },100);

  } else if (sc >= 0.5) {
    // PARTIAL - gentle sparkle
    fb.className = 'feedback close';
    fb.innerHTML = 'כמעט! שים לב למילים: '+wordDiff(target,spoken)+
      '<div class="heard">"'+escHtml(spoken)+'"</div>';
    streak=0; attempts++;
    updateScoreBar();
    vibrate([50,50,50]);

    // Sparkle animation
    showSparkles();
    bubble.classList.remove('shimmer-partial');
    void bubble.offsetWidth;
    bubble.classList.add('shimmer-partial');

    if (attempts>=4) document.getElementById('skipBtn').classList.add('visible');
    safeTimeout(function(){
      if (!currentLesson) return;
      sayHebrew('כמעט, נסה שוב', function(){
        if (!currentLesson) return;
        speakThenListen();
      });
    },800);

  } else {
    // WRONG
    fb.className = 'feedback wrong';
    fb.innerHTML = 'נסה שוב! הקשב טוב: '+wordDiff(target,spoken)+
      '<div class="heard">"'+escHtml(spoken)+'"</div>';
    streak=0; attempts++;
    updateScoreBar();
    vibrate([50,100,50]);
    if (attempts>=4) document.getElementById('skipBtn').classList.add('visible');
    safeTimeout(function(){
      if (!currentLesson) return;
      sayHebrew('לא נורא, נסה שוב', function(){
        if (!currentLesson) return;
        speakThenListen();
      });
    },800);
  }
}

function escHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function skipStep() {
  document.getElementById('skipBtn').classList.remove('visible');
  clearAllTimers(); stopListening(); speechSynthesis.cancel();
  streak=0; updateScoreBar(); advancing=true; safeTimeout(nextStep,100);
}

function nextStep() {
  advancing = false; currentStep++;
  if (!currentLesson) return;
  var total = lessons[currentLesson].sentences.length;
  if (currentStep >= total) {
    stopListening();
    document.getElementById('lessonView').classList.remove('active');
    document.getElementById('completeScreen').classList.add('active');
    document.getElementById('progressFill').style.width = '100%';
    document.getElementById('finalScore').textContent = 'ניקוד: '+score+' / '+(total*3);
    showCompletionFireworks();
    safeTimeout(function(){ sayHebrew('מזל טוב! סיימת את השיעור!',null); },100);
    releaseWakeLock();
  } else {
    showStep(); speakThenListen();
  }
}
</script>
</body>
</html>
