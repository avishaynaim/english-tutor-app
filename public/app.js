// ===== Topics (metadata only - sentences generated by AI) =====
const TOPIC_COLORS = ['blue','pink','orange','green','cyan','purple','red','yellow'];
const XP_PER_LEVEL = 50;

const topics = {
  recipe:{title:"×œ×”×›×™×Ÿ ×¡×œ×˜",icon:"ğŸ¥—",prompt:"making a salad, cooking instructions"},
  daily:{title:"×©×’×¨×ª ×”×™×•× ×©×œ×™",icon:"â˜€ï¸",prompt:"daily morning routine, waking up and going to school"},
  store:{title:"×œ×œ×›×ª ×œ×—× ×•×ª",icon:"ğŸ›’",prompt:"going grocery shopping at a supermarket"},
  introduce:{title:"×œ×”×¦×™×’ ××ª ×¢×¦××š",icon:"ğŸ‘‹",prompt:"introducing yourself to new people"},
  weather:{title:"××–×’ ××•×•×™×¨",icon:"ğŸŒ¤ï¸",prompt:"talking about the weather"},
  family:{title:"×”××©×¤×—×” ×©×œ×™",icon:"ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦",prompt:"describing your family members"},
  school:{title:"×‘×™×ª ×”×¡×¤×¨",icon:"ğŸ«",prompt:"talking about school and classes"},
  doctor:{title:"××¦×œ ×”×¨×•×¤×",icon:"ğŸ©º",prompt:"visiting the doctor when feeling sick"},
  restaurant:{title:"×‘××¡×¢×“×”",icon:"ğŸ½ï¸",prompt:"ordering food at a restaurant"},
  park:{title:"×‘×¤××¨×§",icon:"ğŸŒ³",prompt:"playing at the park"},
  birthday:{title:"×™×•× ×”×•×œ×“×ª",icon:"ğŸ‚",prompt:"celebrating a birthday party"},
  travel:{title:'×˜×™×•×œ ×œ×—×•"×œ',icon:"âœˆï¸",prompt:"traveling abroad, at the airport and hotel"},
  pets:{title:"×—×™×•×ª ××—××“",icon:"ğŸ¶",prompt:"talking about pets, dogs and cats"},
  sports:{title:"×¡×¤×•×¨×˜",icon:"âš½",prompt:"playing sports and games"},
  beach:{title:"×‘×—×•×£ ×”×™×",icon:"ğŸ–ï¸",prompt:"going to the beach, swimming"},
  feelings:{title:"×¨×’×©×•×ª",icon:"ğŸ˜Š",prompt:"expressing feelings and emotions"}
};

// ===== State =====
let currentLesson=null,currentStep=0,recognition=null,listenActive=false,advancing=false;
let pendingTimers=[],attempts=0,score=0,streak=0,wakeLock=null;
let lessonData=null; // Current lesson sentences/translations

let userData={xp:0,level:1,completedTopics:[],totalScore:0,customLessons:[]};
let settings={speechRate:.85,darkMode:false,vibration:true};

const $=id=>document.getElementById(id);

// ===== Init =====
document.addEventListener('DOMContentLoaded',init);

function init(){
  loadData();
  applySettings();
  renderTopics();
  setupEvents();
  checkSpeech();
  initConfetti();
  initRipples();
  updateXPDisplay();
}

// ===== Data Persistence =====
function loadData(){
  try{
    const s=localStorage.getItem('et_settings');
    if(s) settings={...settings,...JSON.parse(s)};
    const u=localStorage.getItem('et_user');
    if(u) userData={...userData,...JSON.parse(u)};
  }catch(e){}
}
function saveSettings(){localStorage.setItem('et_settings',JSON.stringify(settings))}
function saveUser(){localStorage.setItem('et_user',JSON.stringify(userData))}

function applySettings(){
  document.documentElement.setAttribute('data-theme',settings.darkMode?'dark':'light');
  $('speechRate').value=settings.speechRate;
  $('speechRateVal').textContent=settings.speechRate+'x';
  $('darkModeToggle').classList.toggle('active',settings.darkMode);
  $('vibrationToggle').classList.toggle('active',settings.vibration);
}

// ===== XP System =====
function addXP(amount){
  userData.xp+=amount;
  userData.level=Math.floor(userData.xp/XP_PER_LEVEL)+1;
  saveUser();
  updateXPDisplay();
}

function updateXPDisplay(){
  const xpInLevel=userData.xp%XP_PER_LEVEL;
  const pct=(xpInLevel/XP_PER_LEVEL)*100;
  $('levelNum').textContent=userData.level;
  $('levelLabel').textContent=userData.level;
  $('xpFill').style.width=pct+'%';
  $('globalStreak').textContent=userData.completedTopics.length;
  $('topicCount').textContent=userData.completedTopics.length+'/'+Object.keys(topics).length;
}

// ===== Render Topics =====
function renderTopics(){
  const grid=$('topicsGrid');
  grid.innerHTML='';
  const keys=Object.keys(topics);
  keys.forEach((key,i)=>{
    const t=topics[key];
    const color=TOPIC_COLORS[i%TOPIC_COLORS.length];
    const done=userData.completedTopics.includes(key);
    const card=document.createElement('div');
    card.className='topic-card ripple-container';
    card.setAttribute('data-color',color);
    card.style.animationDelay=(i*0.05)+'s';
    card.onclick=(e)=>{addRipple(e);loadAndStartLesson(key)};
    card.innerHTML=`
      ${done?'<div class="topic-check">âœ“</div>':''}
      <div class="topic-icon">${t.icon}</div>
      <div class="topic-label">${t.title}</div>
    `;
    grid.appendChild(card);
  });
}

// ===== Load Lesson from AI =====
function loadAndStartLesson(topicKey){
  const topic=topics[topicKey];
  if(!topic)return;

  // Show loading state
  showView('viewLesson');
  $('sentenceText').textContent='...×˜×•×¢×Ÿ ×©×™×¢×•×¨';
  $('translationText').textContent='';
  $('introText').textContent='×× × ×”××ª×Ÿ';
  $('skipBtn').classList.add('hidden');
  $('stateIdle').classList.add('hidden');
  $('stateListening').classList.add('hidden');
  $('stateSpeaking').classList.add('hidden');

  fetch('/api/generate-lesson',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({scenario:topic.prompt})
  })
  .then(r=>r.json())
  .then(data=>{
    if(data.sentences&&data.sentences.length>0){
      lessonData={
        sentences:data.sentences,
        translations:data.translations||data.sentences.map(()=>'')
      };
      currentLesson=topicKey;
      currentStep=0;advancing=false;
      attempts=1;score=0;streak=0;
      clearAllTimers();
      $('feedbackContainer').innerHTML='';
      updateLessonStats();
      showStep();
      requestWakeLock();
      // Auto-start after showing the step
      safeTimeout(autoStartStep,600);
    }else{
      alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×©×™×¢×•×¨');
      goHome();
    }
  })
  .catch(e=>{
    console.error(e);
    alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×©×™×¢×•×¨');
    goHome();
  });
}

// ===== Events =====
function setupEvents(){
  $('backBtn').onclick=goHome;
  $('replayBtn').onclick=()=>{if(lessonData) sayEnglish(lessonData.sentences[currentStep])};
  $('skipBtn').onclick=skipStep;
  $('continueBtn').onclick=goHome;

  // Bottom nav
  document.querySelectorAll('.nav-item').forEach(btn=>{
    btn.onclick=()=>{
      const view=btn.dataset.view;
      if(view==='home') showView('viewHome');
      else if(view==='settings') showView('viewSettings');
      else if(view==='create') {showView('viewCreate');renderRecentLessons()}
      document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
    };
  });

  $('settingsBackBtn').onclick=goHomeNav;
  $('createBackBtn').onclick=goHomeNav;

  // Create view events
  $('generateScenarioBtn').onclick=generateScenarioLesson;
  $('startCustomTextBtn').onclick=startCustomTextLesson;

  // Settings
  $('speechRate').oninput=e=>{
    settings.speechRate=parseFloat(e.target.value);
    $('speechRateVal').textContent=settings.speechRate+'x';
    saveSettings();
  };
  $('darkModeToggle').onclick=()=>{
    settings.darkMode=!settings.darkMode;
    $('darkModeToggle').classList.toggle('active',settings.darkMode);
    document.documentElement.setAttribute('data-theme',settings.darkMode?'dark':'light');
    saveSettings();
  };
  $('vibrationToggle').onclick=()=>{
    settings.vibration=!settings.vibration;
    $('vibrationToggle').classList.toggle('active',settings.vibration);
    saveSettings();
  };
  $('resetProgress').onclick=()=>{
    if(confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××¤×¡ ××ª ×›×œ ×”×”×ª×§×“××•×ª?')){
      localStorage.clear();
      location.reload();
    }
  };
}

// ===== View Management =====
function showView(id){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  $(id).classList.add('active');
  const showNav=id==='viewHome'||id==='viewSettings'||id==='viewCreate';
  $('bottomNav').style.display=showNav?'flex':'none';
}

function goHomeNav(){
  showView('viewHome');
  document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
  document.querySelector('[data-view="home"]').classList.add('active');
}

// ===== Speech Check =====
function checkSpeech(){
  if(!(window.SpeechRecognition||window.webkitSpeechRecognition)){
    $('viewHome').classList.add('hidden');
    $('noSupport').classList.remove('hidden');
  }
}

// ===== Timers =====
function safeTimeout(fn,ms){
  const id=setTimeout(()=>{pendingTimers=pendingTimers.filter(t=>t!==id);fn()},ms);
  pendingTimers.push(id);return id;
}
function clearAllTimers(){pendingTimers.forEach(id=>clearTimeout(id));pendingTimers=[]}

// ===== Wake Lock =====
async function requestWakeLock(){try{if('wakeLock' in navigator) wakeLock=await navigator.wakeLock.request('screen')}catch(e){}}
function releaseWakeLock(){if(wakeLock){try{wakeLock.release()}catch(e){} wakeLock=null}}

function vibrate(p){if(settings.vibration&&navigator.vibrate) try{navigator.vibrate(p)}catch(e){}}

// ===== TTS =====
function sayEnglish(text,cb){
  speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(text);
  u.lang='en-US';u.rate=settings.speechRate;
  let done=false;
  const fin=()=>{if(done)return;done=true;if(cb)cb()};
  u.onend=fin;u.onerror=fin;
  const fb=safeTimeout(fin,8000);
  u.onend=()=>{clearTimeout(fb);pendingTimers=pendingTimers.filter(t=>t!==fb);fin()};
  speechSynthesis.speak(u);
}
function sayHebrew(text,cb){
  speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(text);
  u.lang='he-IL';u.rate=1;
  let done=false;
  const fin=()=>{if(done)return;done=true;if(cb)cb()};
  u.onend=fin;u.onerror=fin;
  const fb=safeTimeout(fin,5000);
  u.onend=()=>{clearTimeout(fb);pendingTimers=pendingTimers.filter(t=>t!==fb);fin()};
  speechSynthesis.speak(u);
}

// ===== Custom Lessons =====
function generateScenarioLesson(){
  const input=$('scenarioInput').value.trim();
  if(!input){alert('×× × ×ª××¨ ×ª×¨×—×™×©');return}

  $('scenarioLoading').classList.remove('hidden');
  $('generateScenarioBtn').classList.add('hidden');

  fetch('/api/generate-lesson',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({scenario:input})
  })
  .then(r=>r.json())
  .then(data=>{
    $('scenarioLoading').classList.add('hidden');
    $('generateScenarioBtn').classList.remove('hidden');

    if(data.sentences&&data.sentences.length>0){
      const lesson={
        title:input.slice(0,30)+(input.length>30?'...':''),
        icon:'ğŸ­',
        sentences:data.sentences,
        translations:data.translations||data.sentences.map(()=>''),
        isCustom:true,
        createdAt:Date.now()
      };
      saveCustomLesson(lesson);
      startCustomLesson(lesson);
    }else{
      alert('×œ× ×”×¦×œ×—× ×• ×œ×™×¦×•×¨ ×©×™×¢×•×¨. × ×¡×” ×©×•×‘.');
    }
  })
  .catch(e=>{
    $('scenarioLoading').classList.add('hidden');
    $('generateScenarioBtn').classList.remove('hidden');
    alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×”×©×™×¢×•×¨. × ×¡×” ×©×•×‘.');
  });
}

function startCustomTextLesson(){
  const input=$('customTextInput').value.trim();
  if(!input){alert('×× × ×”×›× ×¡ ×˜×§×¡×˜ ×‘×× ×’×œ×™×ª');return}

  const sentences=input
    .split(/[\n.!?]+/)
    .map(s=>s.trim())
    .filter(s=>s.length>0)
    .map(s=>s.endsWith('.')||s.endsWith('!')||s.endsWith('?')?s:s+'.');

  if(sentences.length===0){alert('×œ× × ××¦××• ××©×¤×˜×™× ×ª×§×™× ×™×');return}

  const lesson={
    title:'×ª×¨×’×•×œ ××•×ª××',
    icon:'ğŸ“',
    sentences:sentences.slice(0,10),
    translations:sentences.map(()=>''),
    isCustom:true,
    createdAt:Date.now()
  };

  saveCustomLesson(lesson);
  startCustomLesson(lesson);
}

function saveCustomLesson(lesson){
  if(!userData.customLessons) userData.customLessons=[];
  userData.customLessons.unshift({...lesson,id:Date.now()});
  if(userData.customLessons.length>5) userData.customLessons=userData.customLessons.slice(0,5);
  saveUser();
}

function renderRecentLessons(){
  const container=$('recentLessons');
  const list=$('recentList');
  if(!userData.customLessons||userData.customLessons.length===0){
    container.classList.add('hidden');
    return;
  }
  container.classList.remove('hidden');
  list.innerHTML='';
  userData.customLessons.forEach(lesson=>{
    const item=document.createElement('div');
    item.className='recent-item ripple-container';
    item.onclick=(e)=>{addRipple(e);startCustomLesson(lesson)};
    item.innerHTML=`
      <div class="recent-item-icon">${lesson.icon}</div>
      <div class="recent-item-info">
        <div class="recent-item-title">${esc(lesson.title)}</div>
        <div class="recent-item-count">${lesson.sentences.length} ××©×¤×˜×™×</div>
      </div>
    `;
    list.appendChild(item);
  });
}

function startCustomLesson(lesson){
  lessonData={
    sentences:lesson.sentences,
    translations:lesson.translations
  };
  currentLesson='__custom__';
  currentStep=0;advancing=false;
  attempts=1;score=0;streak=0;
  clearAllTimers();
  showView('viewLesson');
  $('feedbackContainer').innerHTML='';
  updateLessonStats();
  showStep();
  requestWakeLock();
  // Auto-start
  safeTimeout(autoStartStep,600);
}

// ===== Lesson Flow =====
function goHome(){
  clearAllTimers();stopListening();speechSynthesis.cancel();
  advancing=false;currentLesson=null;lessonData=null;
  showView('viewHome');
  renderTopics();
  updateXPDisplay();
  document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
  document.querySelector('[data-view="home"]').classList.add('active');
  releaseWakeLock();
}

function showStep(animate=false){
  if(!lessonData)return;
  const total=lessonData.sentences.length;
  const card=$('sentenceCard');

  const doUpdate=()=>{
    $('progressFill').style.width=((currentStep/total)*100)+'%';
    $('stepBadge').textContent=`×©×œ×‘ ${currentStep+1} ××ª×•×š ${total}`;
    $('sentenceText').textContent=lessonData.sentences[currentStep];
    $('translationText').textContent=lessonData.translations[currentStep]||'';
    $('introText').textContent='×”×§×©×‘ ×•×—×–×•×¨:';
    $('feedbackContainer').innerHTML='';
    // Skip button always visible
    $('skipBtn').classList.remove('hidden');
    card.classList.remove('success-glow','partial-glow','shake','glow','step-out','step-in');
    if(animate) card.classList.add('step-in');
    safeTimeout(()=>card.classList.add('glow'),100);
    attempts=1;updateLessonStats();
    // Hide idle state - we auto-start
    $('stateIdle').classList.add('hidden');
  };

  if(animate){
    card.classList.add('step-out');
    safeTimeout(()=>doUpdate(),250);
  }else{
    doUpdate();
  }
}

function autoStartStep(){
  if(!currentLesson||!lessonData)return;
  // Automatically play and listen - no button needed
  setState('listening');
  const text=lessonData.sentences[currentStep];
  sayEnglish(text,()=>{
    if(!currentLesson)return;
    safeTimeout(()=>{
      if(!currentLesson)return;
      setState('speaking');
      startListening();
    },300);
  });
}

function updateLessonStats(animated=false){
  const scoreEl=$('scoreVal');
  const streakEl=$('streakVal');
  scoreEl.textContent=score;
  streakEl.textContent=streak;

  if(animated){
    scoreEl.classList.remove('score-bump');
    void scoreEl.offsetWidth;
    scoreEl.classList.add('score-bump');
  }

  const badge=$('streakBadge');
  if(streak>=3){
    badge.classList.add('hot');
    if(animated){
      streakEl.classList.remove('streak-bump');
      void streakEl.offsetWidth;
      streakEl.classList.add('streak-bump');
    }
  }else{
    badge.classList.remove('hot');
  }
}

function setState(state){
  $('stateListening').classList.add('hidden');
  $('stateSpeaking').classList.add('hidden');
  $('stateIdle').classList.add('hidden');
  if(state==='listening') $('stateListening').classList.remove('hidden');
  else if(state==='speaking') $('stateSpeaking').classList.remove('hidden');
  // No idle state shown - auto flow
}

// ===== Speech Recognition =====
function stopListeningQuiet(){listenActive=false;if(recognition){try{recognition.abort()}catch(e){} recognition=null}}
function stopListening(){stopListeningQuiet();setState('idle')}

function startListening(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR||!currentLesson)return;
  stopListeningQuiet();listenActive=true;
  recognition=new SR();
  recognition.lang='en-US';recognition.interimResults=false;recognition.continuous=false;recognition.maxAlternatives=1;
  let got=false;
  recognition.onresult=e=>{got=true;evaluateResponse(e.results[0][0].transcript)};
  recognition.onerror=e=>{
    if(!listenActive||!currentLesson)return;
    if(e.error==='no-speech'||e.error==='aborted') restartListening();
    else safeTimeout(restartListening,500);
  };
  recognition.onend=()=>{if(got)return;if(listenActive&&currentLesson&&!advancing) restartListening()};
  try{recognition.start()}catch(e){safeTimeout(restartListening,300)}
}

function restartListening(){
  if(!listenActive||!currentLesson||advancing)return;
  safeTimeout(()=>{if(!currentLesson||advancing)return;listenActive=true;setState('speaking');startListening()},200);
}

// ===== Evaluation =====
function normalize(s){return s.toLowerCase().replace(/[^a-z0-9\s]/g,'').replace(/\s+/g,' ').trim()}
function similarity(a,b){
  const wa=normalize(a).split(' ').filter(Boolean),wb=normalize(b).split(' ').filter(Boolean);
  if(!wa.length||!wb.length)return 0;
  let m=0;for(const w of wa) if(wb.includes(w)) m++;
  return m/Math.max(wa.length,wb.length);
}
function wordDiff(target,spoken){
  const tw=normalize(target).split(' ').filter(Boolean),sw=normalize(spoken).split(' ').filter(Boolean);
  return tw.map(w=>`<span class="${sw.includes(w)?'word-ok':'word-miss'}">${esc(w)}</span>`).join(' ');
}
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

function evaluateResponse(spoken){
  if(!currentLesson||!lessonData)return;
  stopListeningQuiet();
  const target=lessonData.sentences[currentStep];
  const sc=similarity(spoken,target);
  const card=$('sentenceCard');
  const fb=$('feedbackContainer');
  speechSynthesis.cancel();

  if(sc>=0.85){
    const pts=attempts===1?3:attempts===2?2:1;
    score+=pts;streak++;updateLessonStats(true);
    fb.innerHTML=`<div class="feedback-box correct"><div class="feedback-icon">ğŸ‰</div><div class="feedback-text">××¦×•×™×Ÿ!</div><div class="feedback-heard">"${esc(spoken)}"</div></div>`;
    card.classList.remove('glow');card.classList.add('success-glow');
    launchConfetti();vibrate(100);
    advancing=true;
    const isLast=currentStep>=lessonData.sentences.length-1;
    safeTimeout(()=>{
      if(!currentLesson)return;
      sayHebrew(isLast?'×›×œ ×”×›×‘×•×“! ×¡×™×™××ª!':'××¦×•×™×Ÿ!',()=>{if(!currentLesson)return;safeTimeout(nextStep,300)});
    },100);
  } else if(sc>=0.5){
    streak=0;attempts++;updateLessonStats();
    fb.innerHTML=`<div class="feedback-box partial"><div class="feedback-icon">ğŸ‘</div><div class="feedback-text">×›××¢×˜! ×©×™× ×œ×‘:</div><div class="feedback-heard" dir="ltr">${wordDiff(target,spoken)}</div></div>`;
    card.classList.add('partial-glow');showSparkles();vibrate([50,50,50]);
    safeTimeout(()=>{if(!currentLesson)return;sayHebrew('×›××¢×˜, × ×¡×” ×©×•×‘',()=>{if(!currentLesson)return;autoStartStep()})},800);
  } else {
    streak=0;attempts++;updateLessonStats();
    fb.innerHTML=`<div class="feedback-box wrong"><div class="feedback-icon">ğŸ”„</div><div class="feedback-text">× ×¡×” ×©×•×‘!</div><div class="feedback-heard" dir="ltr">${wordDiff(target,spoken)}</div></div>`;
    card.classList.add('shake');setTimeout(()=>card.classList.remove('shake'),500);
    vibrate([50,100,50]);
    safeTimeout(()=>{if(!currentLesson)return;sayHebrew('×œ× × ×•×¨×, × ×¡×” ×©×•×‘',()=>{if(!currentLesson)return;autoStartStep()})},800);
  }
}

function skipStep(){
  clearAllTimers();stopListening();speechSynthesis.cancel();
  streak=0;updateLessonStats();advancing=true;safeTimeout(nextStep,100);
}

function nextStep(){
  advancing=false;currentStep++;
  if(!currentLesson||!lessonData)return;
  const total=lessonData.sentences.length;
  if(currentStep>=total){
    stopListening();
    // Mark completed (only for predefined topics)
    if(currentLesson!=='__custom__'&&!userData.completedTopics.includes(currentLesson)){
      userData.completedTopics.push(currentLesson);
    }
    const xpEarned=score*2;
    addXP(xpEarned);
    userData.totalScore+=score;
    saveUser();

    showView('viewComplete');
    $('progressFill').style.width='100%';
    const maxScore=total*3;
    $('finalScore').textContent=`${score}/${maxScore}`;
    $('finalAccuracy').textContent=Math.round((score/maxScore)*100)+'%';
    $('finalXP').textContent=`+${xpEarned}`;
    showCompletionFireworks();
    safeTimeout(()=>sayHebrew('××–×œ ×˜×•×‘! ×¡×™×™××ª ××ª ×”×©×™×¢×•×¨!',null),100);
    releaseWakeLock();
  } else {
    showStep(true);
    // Auto-start next step after animation
    safeTimeout(autoStartStep,600);
  }
}

// ===== Confetti =====
let confettiCanvas,confettiCtx,confettiPieces=[],confettiRunning=false;
function initConfetti(){
  confettiCanvas=$('confettiCanvas');confettiCtx=confettiCanvas.getContext('2d');
  const resize=()=>{confettiCanvas.width=innerWidth;confettiCanvas.height=innerHeight};
  resize();addEventListener('resize',resize);
}
function launchConfetti(){
  confettiPieces=[];
  const colors=['#6366f1','#818cf8','#ec4899','#22c55e','#f59e0b','#ef4444','#06b6d4','#f472b6'];
  for(let i=0;i<80;i++) confettiPieces.push({
    x:Math.random()*confettiCanvas.width,y:-20-Math.random()*100,
    w:6+Math.random()*6,h:4+Math.random()*4,
    color:colors[Math.floor(Math.random()*colors.length)],
    vx:(Math.random()-.5)*6,vy:2+Math.random()*4,
    rot:Math.random()*360,vr:(Math.random()-.5)*10,life:1
  });
  if(!confettiRunning){confettiRunning=true;animateConfetti()}
}
function animateConfetti(){
  if(!confettiRunning)return;
  confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
  let alive=0;
  for(const p of confettiPieces){
    p.x+=p.vx;p.y+=p.vy;p.vy+=.1;p.rot+=p.vr;p.life-=.008;
    if(p.life<=0)continue;alive++;
    confettiCtx.save();confettiCtx.translate(p.x,p.y);confettiCtx.rotate(p.rot*Math.PI/180);
    confettiCtx.globalAlpha=p.life;confettiCtx.fillStyle=p.color;
    confettiCtx.fillRect(-p.w/2,-p.h/2,p.w,p.h);confettiCtx.restore();
  }
  if(alive>0) requestAnimationFrame(animateConfetti);
  else{confettiRunning=false;confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height)}
}
function showSparkles(){
  const c=document.createElement('div');
  c.style.cssText='position:fixed;inset:0;pointer-events:none;z-index:100';
  document.body.appendChild(c);
  const colors=['#f59e0b','#fbbf24','#fcd34d','#ef4444','#ec4899'];
  const cx=innerWidth/2,cy=innerHeight/2;
  for(let i=0;i<12;i++){
    const d=document.createElement('div');
    d.style.cssText=`position:absolute;width:8px;height:8px;border-radius:50%;left:${cx-40+Math.random()*80}px;top:${cy-20+Math.random()*40}px;background:${colors[Math.floor(Math.random()*colors.length)]};animation:sparkA 1.2s ease-out forwards;opacity:0`;
    c.appendChild(d);
  }
  if(!document.getElementById('sparkS')){
    const s=document.createElement('style');s.id='sparkS';
    s.textContent='@keyframes sparkA{0%{opacity:1;transform:scale(0) translateY(0)}40%{opacity:1;transform:scale(1.2) translateY(-30px)}100%{opacity:0;transform:scale(.5) translateY(-80px)}}';
    document.head.appendChild(s);
  }
  setTimeout(()=>c.remove(),1600);
}
function showCompletionFireworks(){launchConfetti();setTimeout(launchConfetti,500);setTimeout(launchConfetti,1000)}

// ===== Button Ripple Effect =====
function addRipple(e){
  const btn=e.currentTarget;
  const ripple=document.createElement('span');
  ripple.className='ripple';
  const rect=btn.getBoundingClientRect();
  const size=Math.max(rect.width,rect.height);
  ripple.style.width=ripple.style.height=size+'px';
  ripple.style.left=(e.clientX-rect.left-size/2)+'px';
  ripple.style.top=(e.clientY-rect.top-size/2)+'px';
  btn.appendChild(ripple);
  ripple.addEventListener('animationend',()=>ripple.remove());
}

function initRipples(){
  const rippleButtons=document.querySelectorAll('.btn-continue,.replay-btn,.nav-item');
  rippleButtons.forEach(btn=>{
    btn.classList.add('ripple-container');
    btn.addEventListener('click',addRipple);
  });
}

// ===== Service Worker =====
if('serviceWorker' in navigator) addEventListener('load',()=>navigator.serviceWorker.register('/sw.js').catch(()=>{}));
